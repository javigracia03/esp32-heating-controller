server {
  listen 80;
  server_name _;

  # Proxy API requests to the backend service
  location /api/ {

    # --- CORS (needed when accessed via tunnel / different origin) ---
    # If you only ever access through the tunnel, you can also hardcode the origin.
    set $cors_origin "";
    if ($http_origin ~* "^https://[a-z0-9-]+\.trycloudflare\.com$") {
      set $cors_origin $http_origin;
    }

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Requested-With" always;

    # Preflight
    if ($request_method = OPTIONS) {
      add_header Access-Control-Allow-Origin $cors_origin always;
      add_header Access-Control-Allow-Credentials "true" always;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
      add_header Access-Control-Allow-Headers "Authorization, Content-Type, Accept, Origin, User-Agent, DNT, Cache-Control, X-Requested-With" always;
      add_header Content-Length 0;
      add_header Content-Type text/plain;
      return 204;
    }

    proxy_pass http://backend:8000/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Proxy everything else to the frontend service (SPA)
  location / {
    proxy_pass http://frontend:80/;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_redirect off;
  }

  add_header Cache-Control "no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0";
  gzip on;
}
